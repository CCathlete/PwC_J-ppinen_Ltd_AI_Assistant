@startuml Embedding and Server App
skinparam Monochrome false
skinparam BoxPadding 20
skinparam ParticipantPadding 15

box "Control" #F9F9F9
    participant main
    participant DependencyContainer
    participant AppController
end box

box "Application" #F0F7FF
    participant KnowledgeBaseIngestionProcess
end box

box "Domain" #F0FFF0
    participant KnowledgeBaseManager
    participant KnowledgeBaseConfig
end box

box "Infrastructure" #FFF5E6
    participant Env
    participant FileSystem
    participant OpenWebUIConnector
    participant TruncatingFileHandler
end box

== Initialization ==

main -> DependencyContainer : creation of container.
activate DependencyContainer

DependencyContainer -> Env : inject env vars to required classes.
main <- DependencyContainer : back to main and injectted to controller.
deactivate DependencyContainer

== Execution ==

main -> AppController : start
activate AppController

loop Embedding (until SIGKILL)
    AppController -> KnowledgeBaseIngestionProcess : scan and embed
    activate KnowledgeBaseIngestionProcess
    
    KnowledgeBaseIngestionProcess -> KnowledgeBaseManager : trigger manager
    activate KnowledgeBaseManager
    
    KnowledgeBaseManager -> FileSystem : monitor local filesystem
    KnowledgeBaseManager -> KnowledgeBaseConfig : knowledgebase metadata
    

    KnowledgeBaseIngestionProcess -> OpenWebUIConnector : serve UI and monitor

    KnowledgeBaseIngestionProcess -> OpenWebUIConnector : async file embedding via API
    
    KnowledgeBaseIngestionProcess --> AppController : Result[Done]
    deactivate KnowledgeBaseIngestionProcess
    
    note over AppController : Handle Result monad\nWait for next interval
end

loop Server Monitoring (until SIGKILL)
    AppController -> KnowledgeBaseIngestionProcess : trigger server activation
    KnowledgeBaseIngestionProcess -> OpenWebUIConnector : serve UI and monitor

    
    note over AppController : Monitor server and if down restart.
end

deactivate AppController
@enduml